name: Action Health Check
# Monitor daily-update workflow and alert on failures

on:
  schedule:
    # Every 6 hours: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

permissions:
  contents: read
  issues: write

jobs:
  check-health:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Taipei

    steps:
      - name: Check recent workflow runs
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” æª¢æŸ¥ daily-update workflow ç‹€æ…‹..."

          # Get the most recent run of daily-update workflow
          RECENT_RUN=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow "daily-update.yml" \
            --limit 1 \
            --json status,conclusion,createdAt,headBranch,databaseId \
            2>/dev/null || echo "[]")

          if [[ "$RECENT_RUN" == "[]" ]] || [[ -z "$RECENT_RUN" ]]; then
            echo "âš ï¸ ç„¡æ³•å–å¾— workflow åŸ·è¡Œè¨˜éŒ„"
            echo "status=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi

          STATUS=$(echo "$RECENT_RUN" | jq -r '.[0].status')
          CONCLUSION=$(echo "$RECENT_RUN" | jq -r '.[0].conclusion')
          CREATED_AT=$(echo "$RECENT_RUN" | jq -r '.[0].createdAt')
          RUN_ID=$(echo "$RECENT_RUN" | jq -r '.[0].databaseId')

          echo "æœ€è¿‘åŸ·è¡Œæ™‚é–“: $CREATED_AT"
          echo "ç‹€æ…‹: $STATUS"
          echo "çµæžœ: $CONCLUSION"
          echo "Run ID: $RUN_ID"

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "created_at=$CREATED_AT" >> $GITHUB_OUTPUT

          # Check if the run failed
          if [[ "$STATUS" == "completed" && "$CONCLUSION" == "failure" ]]; then
            echo "âŒ æœ€è¿‘çš„åŸ·è¡Œå¤±æ•—äº†ï¼"
            echo "status=failure" >> $GITHUB_OUTPUT
          elif [[ "$STATUS" == "completed" && "$CONCLUSION" == "success" ]]; then
            echo "âœ… æœ€è¿‘çš„åŸ·è¡ŒæˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          elif [[ "$STATUS" == "in_progress" ]] || [[ "$STATUS" == "queued" ]]; then
            echo "â³ æ­£åœ¨åŸ·è¡Œä¸­"
            echo "status=running" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªçŸ¥ç‹€æ…‹: $STATUS / $CONCLUSION"
            echo "status=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Check for stale runs
        id: stale
        run: |
          # Check if last run was more than 36 hours ago (should run daily)
          CREATED_AT="${{ steps.check.outputs.created_at }}"

          if [[ -z "$CREATED_AT" ]]; then
            echo "is_stale=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          CREATED_TS=$(date -d "$CREATED_AT" +%s 2>/dev/null || echo "0")
          NOW_TS=$(date +%s)
          DIFF_HOURS=$(( (NOW_TS - CREATED_TS) / 3600 ))

          echo "è·é›¢ä¸Šæ¬¡åŸ·è¡Œ: ${DIFF_HOURS} å°æ™‚"

          if [[ "$DIFF_HOURS" -gt 36 ]]; then
            echo "âš ï¸ è¶…éŽ 36 å°æ™‚æœªåŸ·è¡Œï¼"
            echo "is_stale=true" >> $GITHUB_OUTPUT
            echo "hours_ago=$DIFF_HOURS" >> $GITHUB_OUTPUT
          else
            echo "is_stale=false" >> $GITHUB_OUTPUT
          fi

      - name: Check existing issues
        id: existing
        if: steps.check.outputs.status == 'failure' || steps.stale.outputs.is_stale == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's already an open issue for this
          EXISTING=$(gh issue list \
            --repo ${{ github.repository }} \
            --label "action-health" \
            --state open \
            --limit 1 \
            --json number \
            2>/dev/null || echo "[]")

          if [[ "$EXISTING" != "[]" ]] && [[ -n "$EXISTING" ]]; then
            ISSUE_NUM=$(echo "$EXISTING" | jq -r '.[0].number')
            echo "ðŸ“‹ å·²æœ‰é–‹å•Ÿçš„ Issue: #$ISSUE_NUM"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create failure issue
        if: steps.check.outputs.status == 'failure' && steps.existing.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ steps.check.outputs.run_id }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${RUN_ID}"
          CREATED_AT="${{ steps.check.outputs.created_at }}"

          BODY=$(cat <<EOF
          ## å•é¡Œæè¿°

          Daily Update workflow åŸ·è¡Œå¤±æ•—ã€‚

          ## è©³ç´°è³‡è¨Š

          - **åŸ·è¡Œæ™‚é–“**: ${CREATED_AT}
          - **Run ID**: ${RUN_ID}
          - **åŸ·è¡Œè¨˜éŒ„**: ${RUN_URL}

          ## å»ºè­°æª¢æŸ¥

          1. æª¢æŸ¥ [åŸ·è¡Œè¨˜éŒ„](${RUN_URL}) äº†è§£å¤±æ•—åŽŸå› 
          2. å¸¸è¦‹å•é¡Œåƒè€ƒ CLAUDE.md çš„å•é¡ŒæŽ’é™¤ç« ç¯€
          3. æª¢æŸ¥ API é€£ç·šç‹€æ…‹ï¼ˆç«‹æ³•é™¢ APIã€OpenAIã€Qdrantï¼‰

          ## è‡ªå‹•é—œé–‰

          æ­¤ Issue åœ¨ä¸‹æ¬¡ workflow åŸ·è¡ŒæˆåŠŸå¾Œå¯æ‰‹å‹•é—œé–‰ã€‚
          EOF
          )

          gh issue create \
            --repo ${{ github.repository }} \
            --title "ðŸš¨ Daily Update Workflow åŸ·è¡Œå¤±æ•—" \
            --label "action-health,bug" \
            --body "$BODY"

          echo "âœ… å·²å»ºç«‹ Issue"

      - name: Create stale issue
        if: steps.stale.outputs.is_stale == 'true' && steps.existing.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CREATED_AT="${{ steps.check.outputs.created_at }}"
          HOURS_AGO="${{ steps.stale.outputs.hours_ago }}"

          BODY=$(cat <<EOF
          ## å•é¡Œæè¿°

          Daily Update workflow å·²è¶…éŽ 36 å°æ™‚æœªåŸ·è¡Œã€‚

          ## è©³ç´°è³‡è¨Š

          - **ä¸Šæ¬¡åŸ·è¡Œ**: ${CREATED_AT}
          - **å·²éŽæ™‚é–“**: ${HOURS_AGO} å°æ™‚

          ## å¯èƒ½åŽŸå› 

          1. GitHub Actions æŽ’ç¨‹å»¶é²
          2. Workflow è¢«åœç”¨
          3. Repository è¨­å®šå•é¡Œ

          ## å»ºè­°å‹•ä½œ

          1. æ‰‹å‹•è§¸ç™¼ workflow: Actions â†’ Daily Legislative Data Update â†’ Run workflow
          2. æª¢æŸ¥ workflow æ˜¯å¦è¢«åœç”¨
          EOF
          )

          gh issue create \
            --repo ${{ github.repository }} \
            --title "âš ï¸ Daily Update Workflow è¶…æ™‚æœªåŸ·è¡Œ" \
            --label "action-health" \
            --body "$BODY"

          echo "âœ… å·²å»ºç«‹ Issue"

      - name: Update existing issue
        if: (steps.check.outputs.status == 'failure' || steps.stale.outputs.is_stale == 'true') && steps.existing.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.existing.outputs.issue_number }}"
          RUN_ID="${{ steps.check.outputs.run_id }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${RUN_ID}"
          CHECK_STATUS="${{ steps.check.outputs.status }}"
          CHECK_TIME=$(date '+%Y-%m-%d %H:%M:%S')

          COMMENT=$(cat <<EOF
          ## å¥åº·æª¢æŸ¥æ›´æ–°

          - **æª¢æŸ¥æ™‚é–“**: ${CHECK_TIME}
          - **ç‹€æ…‹**: ${CHECK_STATUS}
          - **æœ€è¿‘åŸ·è¡Œ**: [Run #${RUN_ID}](${RUN_URL})

          å•é¡Œä»æœªè§£æ±ºã€‚
          EOF
          )

          gh issue comment "$ISSUE_NUM" \
            --repo ${{ github.repository }} \
            --body "$COMMENT"

          echo "âœ… å·²æ›´æ–° Issue #$ISSUE_NUM"

      - name: Summary
        run: |
          echo "========================================="
          echo "å¥åº·æª¢æŸ¥å®Œæˆ"
          echo "========================================="
          echo "æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "Workflow ç‹€æ…‹: ${{ steps.check.outputs.status }}"
          echo "æ˜¯å¦éŽæœŸ: ${{ steps.stale.outputs.is_stale }}"
          echo "========================================="
