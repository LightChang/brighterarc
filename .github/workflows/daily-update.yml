name: Daily Legislative Data Update
# Workflow for automated daily data pipeline

on:
  schedule:
    # æ¯å¤© UTC 18:30ï¼ˆå°åŒ—æ™‚é–“ 02:30 éš”å¤©ï¼‰
    # æ³¨æ„ï¼šcron ä½¿ç”¨ UTC æ™‚é–“ï¼Œä½† job å…§çš„ TZ è¨­ç‚º Asia/Taipei
    # æ‰€ä»¥ date å‘½ä»¤æœƒè¿”å›å°åŒ—æ™‚é–“çš„æ—¥æœŸ
    - cron: '30 18 * * *'
  workflow_dispatch:
    # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      limit:
        description: 'æŠ“å–è³‡æ–™ç­†æ•¸'
        required: false
        default: '100'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Taipei  # ä½¿ç”¨å°åŒ—æ™‚å€

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦ fetch å®Œæ•´æ­·å²ä»¥ä¾¿ push
          fetch-depth: 0

      - name: Setup environment
        run: |
          # å®‰è£å¿…è¦çš„å·¥å…·
          sudo apt-get update
          sudo apt-get install -y jq curl gzip

          # æª¢æŸ¥è…³æœ¬æ¬Šé™
          chmod +x sources/legislative/*.sh
          chmod +x commitments/*.sh

      - name: Fetch legislative data
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ“¥ æŠ“å–ç«‹æ³•é™¢è³‡æ–™..."
          LIMIT="${{ github.event.inputs.limit || '100' }}"
          ./sources/legislative/fetch.sh --limit "$LIMIT"

          # æª¢æŸ¥æ˜¯å¦æœ‰ç”¢ç”Ÿæª”æ¡ˆ
          TODAY=$(date +%Y-%m-%d)
          if [[ ! -f "data/daily/${TODAY}.jsonl" ]]; then
            echo "âŒ è³‡æ–™æŠ“å–å¤±æ•—ï¼šæª”æ¡ˆä¸å­˜åœ¨"
            exit 1
          fi

          echo "âœ… è³‡æ–™æŠ“å–å®Œæˆ"

      - name: Update Qdrant
        env:
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
        run: |
          echo "ğŸ“¤ ä¸Šå‚³è³‡æ–™åˆ° Qdrant..."
          TODAY=$(date +%Y-%m-%d)
          ./sources/legislative/update_qdrant.sh --input "data/daily/${TODAY}.jsonl"

          echo "âœ… Qdrant æ›´æ–°å®Œæˆ"

      - name: Verify Qdrant upload
        env:
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
        run: |
          echo "ğŸ” é©—è­‰ Qdrant è³‡æ–™..."
          TODAY=$(date +%Y-%m-%d)
          DATA_FILE="data/daily/${TODAY}.jsonl"

          # å–å¾—ä»Šå¤©ä¸Šå‚³çš„ç¬¬ä¸€ç­†å’Œæœ€å¾Œä¸€ç­† ID ä½œç‚ºé©—è­‰æ¨£æœ¬
          FIRST_ID=$(head -1 "$DATA_FILE" | jq -r '.id')
          LAST_ID=$(tail -1 "$DATA_FILE" | jq -r '.id')
          SAMPLE_IDS="[\"$FIRST_ID\", \"$LAST_ID\"]"
          SAMPLE_COUNT=2

          echo "ğŸ“Š é©—è­‰æ¨£æœ¬æ•¸: $SAMPLE_COUNT"

          # æŸ¥è©¢ Qdrant ç¢ºèªé€™äº› ID å­˜åœ¨
          RESPONSE=$(curl -sS --connect-timeout 15 --max-time 30 --retry 3 --retry-delay 2 \
            -X POST "${QDRANT_URL}/collections/legislative_replies/points" \
            -H "Content-Type: application/json" \
            -H "api-key: ${QDRANT_API_KEY}" \
            -d "{\"ids\": $SAMPLE_IDS, \"with_payload\": false, \"with_vector\": false}")

          # æª¢æŸ¥å›å‚³çµæœ
          if ! echo "$RESPONSE" | jq -e '.result' > /dev/null 2>&1; then
            echo "âŒ Qdrant æŸ¥è©¢å¤±æ•—"
            echo "$RESPONSE"
            exit 1
          fi

          FOUND_COUNT=$(echo "$RESPONSE" | jq '.result | length')
          echo "âœ… æ‰¾åˆ° $FOUND_COUNT / $SAMPLE_COUNT ç­†è³‡æ–™"

          if [[ "$FOUND_COUNT" -lt "$SAMPLE_COUNT" ]]; then
            echo "âš ï¸  éƒ¨åˆ†è³‡æ–™æœªå¯«å…¥ Qdrant"
            echo "é æœŸ: $SAMPLE_COUNT, å¯¦éš›: $FOUND_COUNT"
            exit 1
          fi

          # é¡¯ç¤ºç¸½ points æ•¸
          TOTAL=$(curl -sS --connect-timeout 15 --max-time 30 --retry 3 --retry-delay 2 \
            -H "api-key: ${QDRANT_API_KEY}" \
            "${QDRANT_URL}/collections/legislative_replies" | jq '.result.points_count')
          echo "ğŸ“ˆ Qdrant ç¸½è³‡æ–™ç­†æ•¸: $TOTAL"

          echo "âœ… Qdrant é©—è­‰é€šé"

      - name: Build monthly release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ å»ºç«‹/æ›´æ–°æœˆåº¦ Release..."
          TODAY=$(date +%Y-%m-%d)
          ./sources/legislative/build_release.sh --input "data/daily/${TODAY}.jsonl"

          echo "âœ… Release æ›´æ–°å®Œæˆ"

      - name: Commit daily data
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          TODAY=$(date +%Y-%m-%d)

          # åª commit æ–°å¢çš„æ¯æ—¥è³‡æ–™
          git add "data/daily/${TODAY}.jsonl"

          # å¦‚æœæœ‰è®Šæ›´æ‰ commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²’æœ‰éœ€è¦æäº¤çš„è®Šæ›´"
          else
            git commit -m "Add data for ${TODAY}" -m "- Fetched and embedded legislative data" -m "- Updated Qdrant" -m "- Updated monthly release" -m "Co-Authored-By: GitHub Actions <actions@github.com>"

            # Push åˆ° main åˆ†æ”¯
            git push origin main

            echo "âœ… è³‡æ–™å·²æäº¤åˆ° Git"
          fi

      # ===== æ‰¿è«¾è™•ç† =====
      - name: Extract new commitments
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ“‹ èƒå–æ–°æ‰¿è«¾..."
          TODAY=$(date +%Y-%m-%d)
          ./commitments/extract.sh --input "data/daily/${TODAY}.jsonl"
          echo "âœ… æ‰¿è«¾èƒå–å®Œæˆ"

      - name: Update commitment status
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ”„ æ›´æ–°æ‰¿è«¾ç‹€æ…‹..."
          TODAY=$(date +%Y-%m-%d)
          ./commitments/update_status.sh --input "data/daily/${TODAY}.jsonl"
          echo "âœ… ç‹€æ…‹æ›´æ–°å®Œæˆ"

      - name: Build commitment index
        run: |
          echo "ğŸ“Š ç”¢ç”Ÿæ‰¿è«¾ç´¢å¼•..."
          ./commitments/build_index.sh
          echo "âœ… ç´¢å¼•ç”¢ç”Ÿå®Œæˆ"

      - name: Commit commitments
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          TODAY=$(date +%Y-%m-%d)

          # åŠ å…¥æ‰¿è«¾ç›¸é—œæª”æ¡ˆ
          git add docs/commitments/

          # å¦‚æœæœ‰è®Šæ›´æ‰ commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²’æœ‰æ–°çš„æ‰¿è«¾è®Šæ›´"
          else
            git commit -m "Update commitments for ${TODAY}"
            git push origin main
            echo "âœ… æ‰¿è«¾å·²æäº¤åˆ° Git"
          fi

      - name: Summary
        if: always()
        run: |
          echo "========================================="
          echo "æ¯æ—¥æ›´æ–°å®Œæˆ"
          echo "========================================="
          echo "æ—¥æœŸ: $(date +%Y-%m-%d)"
          echo "ç‹€æ…‹: ${{ job.status }}"
          echo "========================================="
