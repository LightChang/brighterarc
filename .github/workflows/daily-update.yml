name: Daily Legislative Data Update
# Workflow for automated daily data pipeline

on:
  schedule:
    # æ¯å¤© UTC 18:30ï¼ˆå°åŒ—æ™‚é–“ 02:30 éš”å¤©ï¼‰
    # æ³¨æ„ï¼šcron ä½¿ç”¨ UTC æ™‚é–“ï¼Œä½† job å…§çš„ TZ è¨­ç‚º Asia/Taipei
    # æ‰€ä»¥ date å‘½ä»¤æœƒè¿”å›å°åŒ—æ™‚é–“çš„æ—¥æœŸ
    - cron: '30 18 * * *'
  workflow_dispatch:
    # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      limit:
        description: 'æŠ“å–è³‡æ–™ç­†æ•¸'
        required: false
        default: '100'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Taipei  # ä½¿ç”¨å°åŒ—æ™‚å€

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦ fetch å®Œæ•´æ­·å²ä»¥ä¾¿ push
          fetch-depth: 0

      - name: Setup environment
        run: |
          # å®‰è£å¿…è¦çš„å·¥å…·
          sudo apt-get update
          sudo apt-get install -y jq curl gzip

          # æª¢æŸ¥è…³æœ¬æ¬Šé™
          chmod +x *.sh

      - name: Fetch legislative data
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ“¥ æŠ“å–ç«‹æ³•é™¢è³‡æ–™..."
          LIMIT="${{ github.event.inputs.limit || '100' }}"
          ./fetch_legislative_data.sh --limit "$LIMIT"

          # æª¢æŸ¥æ˜¯å¦æœ‰ç”¢ç”Ÿæª”æ¡ˆ
          TODAY=$(date +%Y-%m-%d)
          if [[ ! -f "data/daily/${TODAY}.jsonl" ]]; then
            echo "âŒ è³‡æ–™æŠ“å–å¤±æ•—ï¼šæª”æ¡ˆä¸å­˜åœ¨"
            exit 1
          fi

          echo "âœ… è³‡æ–™æŠ“å–å®Œæˆ"

      - name: Update Qdrant
        env:
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
        run: |
          echo "ğŸ“¤ ä¸Šå‚³è³‡æ–™åˆ° Qdrant..."
          TODAY=$(date +%Y-%m-%d)
          ./update_legislative_qdrant.sh --input "data/daily/${TODAY}.jsonl"

          echo "âœ… Qdrant æ›´æ–°å®Œæˆ"

      - name: Build monthly release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ å»ºç«‹/æ›´æ–°æœˆåº¦ Release..."
          TODAY=$(date +%Y-%m-%d)
          ./build_legislative_release.sh --input "data/daily/${TODAY}.jsonl"

          echo "âœ… Release æ›´æ–°å®Œæˆ"

      - name: Commit daily data
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          TODAY=$(date +%Y-%m-%d)

          # åª commit æ–°å¢çš„æ¯æ—¥è³‡æ–™
          git add "data/daily/${TODAY}.jsonl"

          # å¦‚æœæœ‰è®Šæ›´æ‰ commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²’æœ‰éœ€è¦æäº¤çš„è®Šæ›´"
          else
            git commit -m "Add data for ${TODAY}" -m "- Fetched and embedded legislative data" -m "- Updated Qdrant" -m "- Updated monthly release" -m "Co-Authored-By: GitHub Actions <actions@github.com>"

            # Push åˆ° main åˆ†æ”¯
            git push origin main

            echo "âœ… è³‡æ–™å·²æäº¤åˆ° Git"
          fi

      - name: Summary
        if: always()
        run: |
          echo "========================================="
          echo "æ¯æ—¥æ›´æ–°å®Œæˆ"
          echo "========================================="
          echo "æ—¥æœŸ: $(date +%Y-%m-%d)"
          echo "ç‹€æ…‹: ${{ job.status }}"
          echo "========================================="
